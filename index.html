<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FIRE Model</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg: #070a12;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --muted2: rgba(255,255,255,0.48);
      --brand: #7c5cff;
      --good: #3ddc97;
      --bad: #ff5c7a;
      --warn:#f6c177;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 22px;
      --gap: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 20% -20%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(900px 500px at 110% 20%, rgba(61,220,151,.15), transparent 55%),
        radial-gradient(800px 500px at 30% 120%, rgba(255,92,122,.10), transparent 55%),
        var(--bg);
      min-height: 100vh;
      padding: 24px;
    }

    .shell{
      max-width: 1180px;
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap: 18px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .dot{
      width: 14px; height:14px; border-radius: 999px;
      background: var(--brand);
      box-shadow: 0 0 0 6px rgba(124,92,255,.18);
    }
    .pill{
      display:inline-flex;
      gap: 8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
    }
    .pill .ok{
      width:8px;height:8px;border-radius:999px;background: var(--good);
    }
    .pill .bad{
      width:8px;height:8px;border-radius:999px;background: var(--bad);
    }

    .tabs{
      display:flex;
      gap: 6px;
      padding: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--stroke);
    }
    .tab{
      padding: 10px 14px;
      border-radius: 999px;
      color: var(--muted);
      font-weight: 700;
      cursor:pointer;
      user-select:none;
      transition: all .15s ease;
    }
    .tab.active{
      background: rgba(124,92,255,.20);
      color: var(--text);
      border: 1px solid rgba(124,92,255,.35);
    }

    .page{
      display:none;
      gap: 16px;
    }
    .page.active{ display:grid; }

    .grid2{ grid-template-columns: 1.1fr .9fr; }
    .grid1{ grid-template-columns: 1fr; }
    @media(max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    .card h2, .card h3{
      margin: 0 0 12px 0;
      letter-spacing: .2px;
    }
    .card h2{ font-size: 22px; }
    .card h3{ font-size: 16px; color: var(--text); opacity: .95; }

    .sub{
      color: var(--muted);
      font-size: 13px;
      margin-top: -6px;
      margin-bottom: 14px;
      line-height: 1.4;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media(max-width: 640px){
      .row{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 700;
      letter-spacing: .25px;
    }
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    textarea{
      min-height: 140px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.45;
      resize: vertical;
    }
    input::placeholder{ color: rgba(255,255,255,.35); }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .btn{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.07);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 800;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(124,92,255,.40);
      background: linear-gradient(90deg, rgba(124,92,255,.55), rgba(61,220,151,.30));
    }
    .btn.danger{
      border-color: rgba(255,92,122,.35);
      background: rgba(255,92,122,.12);
    }

    .hr{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 14px 0;
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    @media(max-width: 980px){
      .kpis{ grid-template-columns: repeat(2,1fr); }
    }
    @media(max-width: 520px){
      .kpis{ grid-template-columns: 1fr; }
    }
    .kpi{
      padding: 14px;
      border-radius: var(--radius);
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.10);
    }
    .kpi .k{ color: var(--muted); font-size: 12px; font-weight: 800; }
    .kpi .v{ font-size: 22px; font-weight: 900; margin-top: 6px; }

    .note{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }

    .table-wrap{
      overflow:auto;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 760px;
    }
    th, td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 13px;
      white-space: nowrap;
    }
    th{
      position: sticky;
      top: 0;
      background: rgba(10,14,24,.95);
      color: var(--muted);
      text-align: left;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .small{
      font-size: 12px;
      color: var(--muted2);
    }

    .status{
      display:flex; align-items:center; gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-weight: 700;
      margin-bottom: 10px;
    }

    .status .check{
      width: 16px; height: 16px;
      border-radius: 4px;
      background: rgba(61,220,151,.18);
      border: 1px solid rgba(61,220,151,.35);
      display:grid; place-items:center;
      color: var(--good);
      font-weight: 900;
      font-size: 12px;
    }

    .badge{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }

    .twoCharts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media(max-width: 980px){
      .twoCharts{ grid-template-columns: 1fr; }
    }

    .mutedBox{
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
      font-family: var(--mono);
      white-space: pre-wrap;
      overflow:auto;
      max-height: 260px;
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="font-size:18px;">FIRE Model</div>
            <div id="apiPill" class="pill"><span class="bad"></span> API: unknown</div>
          </div>
          <div class="small" style="margin-top:2px;">API-connected planner (cash + stocks + properties + offsets)</div>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="home">Home</div>
        <div class="tab" data-tab="inputs">Inputs</div>
        <div class="tab" data-tab="results">Results</div>
      </div>
    </div>

    <!-- HOME -->
    <div id="page-home" class="page active grid2">
      <div class="card">
        <h2>Home</h2>
        <div class="sub">Quick sanity checks and navigation.</div>

        <div class="row">
          <div>
            <label>API Base URL</label>
            <input id="apiBase" placeholder="https://fire-api-wixz.onrender.com" />
            <div class="small" style="margin-top:6px;">Must include https:// (Render URL). Stored locally in your browser.</div>
          </div>
          <div>
            <label>Mode</label>
            <select id="mode">
              <option value="yearly" selected>Yearly (recommended)</option>
              <option value="monthly">Monthly (debug / heavy)</option>
            </select>
            <div class="small" style="margin-top:6px;">Yearly makes tables + charts faster.</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" onclick="checkHealth()">Check API health</button>
          <button class="btn primary" onclick="goTab('inputs')">Go to inputs</button>
          <button class="btn" onclick="loadDefaults()">Load defaults</button>
        </div>

        <div class="hr"></div>
        <div class="note">
          Tip: If Netlify shows “no request”, it usually means your frontend isn’t calling the correct endpoint or the API is down.
          This UI calls <span class="badge">POST /run_fire_model</span> by default (see code — change if needed).
        </div>
      </div>

      <div class="card">
        <h2>Status</h2>
        <div id="homeStatus" class="status">
          <div class="check">i</div>
          <div>Set your API Base URL, then run a health check.</div>
        </div>

        <div class="sub">Last saved request payload (what we send to the API):</div>
        <div id="payloadPreview" class="mutedBox">{}</div>
      </div>
    </div>

    <!-- INPUTS -->
    <div id="page-inputs" class="page grid2">
      <div class="card">
        <h2>Core inputs</h2>
        <div class="sub">These map 1:1 to your API’s <span class="badge">inputs</span> object.</div>

        <div class="row">
          <div>
            <label>current_age</label>
            <input id="current_age" type="number" step="1" />
          </div>
          <div>
            <label>end_age</label>
            <input id="end_age" type="number" step="1" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>initial_savings</label>
            <input id="initial_savings" type="number" step="1" />
          </div>
          <div>
            <label>todays_lifestyle_income</label>
            <input id="todays_lifestyle_income" type="number" step="1" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>current_income</label>
            <input id="current_income" type="number" step="1" />
          </div>
          <div>
            <label>current_expenses</label>
            <input id="current_expenses" type="number" step="1" />
          </div>
        </div>

        <details style="margin-top:12px;">
          <summary class="btn" style="display:inline-flex;align-items:center;gap:8px;">Advanced assumptions</summary>
          <div style="margin-top:12px;" class="row">
            <div>
              <label>inflation</label>
              <input id="inflation" type="number" step="0.001" />
            </div>
            <div>
              <label>average_salary_increase</label>
              <input id="average_salary_increase" type="number" step="0.001" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>stock_growth</label>
              <input id="stock_growth" type="number" step="0.001" />
            </div>
            <div>
              <label>stock_yearly_contribution</label>
              <input id="stock_yearly_contribution" type="number" step="1" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>starting_stock_value</label>
              <input id="starting_stock_value" type="number" step="1" />
            </div>
            <div></div>
          </div>
        </details>

        <div class="actions">
          <button class="btn" onclick="saveState()">Save inputs</button>
          <button class="btn primary" onclick="runModel()">Run model</button>
        </div>

        <div class="hr"></div>
        <div class="note">
          Note: The property editor on the right builds the <span class="badge">property_list</span> JSON automatically.
        </div>
      </div>

      <div class="card">
        <h2>Properties</h2>
        <div class="sub">Edit PPOR + investment properties as separate cards (no raw JSON needed).</div>

        <div id="propCards"></div>

        <div class="actions">
          <button class="btn" onclick="addInvestmentProperty()">+ Add investment property</button>
          <button class="btn" onclick="resetProperties()">Reset properties</button>
        </div>

        <div class="hr"></div>
        <div class="note">Debug: property_list we will send:</div>
        <div id="propertyJsonPreview" class="mutedBox">[]</div>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="page-results" class="page grid1">
      <div class="card">
        <h2>Results</h2>
        <div class="sub">Charts + tables based on the API response.</div>

        <div class="kpis">
          <div class="kpi"><div class="k">Cash (end)</div><div class="v" id="kpiCashEnd">—</div></div>
          <div class="kpi"><div class="k">Stocks (end)</div><div class="v" id="kpiStocksEnd">—</div></div>
          <div class="kpi"><div class="k">Net worth (end)</div><div class="v" id="kpiNWEnd">—</div></div>
          <div class="kpi"><div class="k">Rows returned</div><div class="v" id="kpiRows">—</div></div>
        </div>

        <div class="hr"></div>

        <div class="actions" style="justify-content:flex-end;">
          <button class="btn" onclick="downloadCSV()">Download CSV</button>
          <button class="btn" onclick="goTab('inputs')">Edit inputs</button>
        </div>

        <div class="twoCharts" style="margin-top:12px;">
          <div class="card" style="box-shadow:none;">
            <h3>Cash vs Stocks</h3>
            <canvas id="chartMain" height="140"></canvas>
          </div>
          <div class="card" style="box-shadow:none;">
            <h3>Property values</h3>
            <canvas id="chartProps" height="140"></canvas>
          </div>
        </div>

        <div class="hr"></div>

        <h3>Property summary (end row)</h3>
        <div class="table-wrap">
          <table id="propertySummaryTable">
            <thead>
              <tr>
                <th>Property</th>
                <th>Is PPOR</th>
                <th>Value (end)</th>
                <th>Mortgage balance (end)</th>
                <th>Offset allocated (end)</th>
                <th>Rent (period)</th>
                <th>Net rent (period)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="hr"></div>

        <h3>Full table (first 200 rows shown)</h3>
        <div class="table-wrap">
          <table id="fullTable">
            <thead id="fullThead"></thead>
            <tbody id="fullTbody"></tbody>
          </table>
        </div>

        <div class="hr"></div>
        <h3>Raw API response (debug)</h3>
        <div id="rawResp" class="mutedBox">{}</div>
      </div>
    </div>
  </div>

<script>
  // -----------------------------
  // CONFIG (adjust if needed)
  // -----------------------------
  // If your FastAPI endpoint is different (e.g. POST /fire), change here:
  const ENDPOINT_RUN = "/run_fire_model";   // <--- change if your API uses another path
  const ENDPOINT_HEALTH = "/health";

  // -----------------------------
  // STATE
  // -----------------------------
  const LS_KEY = "fire_frontend_state_v2";
  let lastResult = null;
  let chartMain = null;
  let chartProps = null;

  const defaultState = {
    apiBase: "https://fire-api-wixz.onrender.com",
    mode: "yearly",
    inputs: {
      current_age: 25,
      inflation: 0.025,
      todays_lifestyle_income: 80000,
      initial_savings: 500000,
      current_income: 200000,
      current_expenses: 64000,
      average_salary_increase: 0.035,
      end_age: 60,
      stock_growth: 0.06,
      stock_yearly_contribution: 20000,
      starting_stock_value: 35000
    },
    properties: {
      ppor: {
        id: 3,
        name: "PPOR",
        purchase_price: 1200000,
        current_value: 1200000,
        original_loan: 900000,
        loan_balance_current: 0,
        purchase_fees: 40000,
        monthly_rent: 0,
        strata_quarterly: 0,
        rates_quarterly: 900,
        other_costs_monthly: 300,
        interest_rate: 0.055,
        property_growth: 0.03,
        rental_growth: 0,
        year_bought: 2027,
        loan_term_years: 30,
        use_offset: true,
        is_owner_occupied: true
      },
      investments: [
        {
          id: 1,
          name: "Apartment",
          purchase_price: 400000,
          current_value: 640000,
          original_loan: 325000,
          loan_balance_current: 215000,
          purchase_fees: 20000,
          monthly_rent: 2400,
          strata_quarterly: 1200,
          rates_quarterly: 900,
          other_costs_monthly: 200,
          interest_rate: 0.055,
          property_growth: 0.03,
          rental_growth: 0.03,
          year_bought: 2021,
          loan_term_years: 30,
          use_offset: true,
          is_owner_occupied: false
        },
        {
          id: 2,
          name: "House",
          purchase_price: 750000,
          current_value: 820000,
          original_loan: 600000,
          loan_balance_current: 540000,
          purchase_fees: 35000,
          monthly_rent: 3200,
          strata_quarterly: 1200,
          rates_quarterly: 900,
          other_costs_monthly: 200,
          interest_rate: 0.055,
          property_growth: 0.03,
          rental_growth: 0.03,
          year_bought: 2028,
          loan_term_years: 30,
          use_offset: true,
          is_owner_occupied: false
        }
      ]
    }
  };

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return structuredClone(defaultState);
      const s = JSON.parse(raw);
      return {
        ...structuredClone(defaultState),
        ...s,
        inputs: { ...structuredClone(defaultState.inputs), ...(s.inputs||{}) },
        properties: {
          ...structuredClone(defaultState.properties),
          ...(s.properties||{}),
          ppor: { ...structuredClone(defaultState.properties.ppor), ...((s.properties||{}).ppor||{}) },
          investments: Array.isArray((s.properties||{}).investments) ? (s.properties.investments) : structuredClone(defaultState.properties.investments)
        }
      };
    }catch{
      return structuredClone(defaultState);
    }
  }

  let state = loadState();

  function saveState(){
    readInputsIntoState();
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    renderPreviews();
    toast("Saved.");
  }

  function loadDefaults(){
    state = structuredClone(defaultState);
    syncUIFromState();
    renderPropertyCards();
    renderPreviews();
    toast("Defaults loaded.");
  }

  // -----------------------------
  // UI NAV
  // -----------------------------
  function goTab(tab){
    document.querySelectorAll(".tab").forEach(t=>{
      t.classList.toggle("active", t.dataset.tab === tab);
    });
    document.querySelectorAll(".page").forEach(p=>{
      p.classList.toggle("active", p.id === `page-${tab}`);
    });
  }

  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>goTab(t.dataset.tab));
  });

  // -----------------------------
  // HEALTH CHECK
  // -----------------------------
  async function checkHealth(){
    readInputsIntoState();
    const base = state.apiBase.replace(/\/+$/,"");
    setHomeStatus("Checking API health…");
    try{
      const res = await fetch(base + ENDPOINT_HEALTH, { method:"GET" });
      const ok = res.ok;
      const data = await res.json().catch(()=> ({}));
      setApiPill(ok, ok ? "ok" : "down");
      setHomeStatus(ok ? `API healthy: ${JSON.stringify(data)}` : `API responded ${res.status}`);
      toast(ok ? "API OK" : "API not OK");
    }catch(e){
      setApiPill(false, "down");
      setHomeStatus("API unreachable. Check URL / CORS / Render status.");
      toast("API unreachable");
    }
  }

  function setApiPill(ok, label){
    const pill = document.getElementById("apiPill");
    pill.innerHTML = `<span class="${ok ? "ok" : "bad"}"></span> API: ${label}`;
  }

  function setHomeStatus(msg){
    document.getElementById("homeStatus").innerHTML = `<div class="check">i</div><div>${msg}</div>`;
  }

  // -----------------------------
  // PROPERTY EDITOR
  // -----------------------------
  function buildPropertyList(){
    // PPOR first (nice for predictable ordering)
    const ppor = normalizeProperty(state.properties.ppor, true, 1);
    // investments
    const inv = (state.properties.investments || []).map((p, idx)=>normalizeProperty(p, false, idx+2));
    // ensure ids are unique-ish
    return [...inv, ppor];
  }

  function normalizeProperty(p, isPPOR, fallbackId){
    const out = { ...(p||{}) };
    if(!out.id) out.id = fallbackId;
    if(!out.name) out.name = isPPOR ? "PPOR" : `Property ${fallbackId}`;
    out.is_owner_occupied = !!(isPPOR || out.is_owner_occupied);
    // guard rails
    if(out.is_owner_occupied){
      out.monthly_rent = 0;
      out.rental_growth = 0;
    }
    // coerce numbers
    const numKeys = [
      "purchase_price","current_value","original_loan","loan_balance_current","purchase_fees",
      "monthly_rent","strata_quarterly","rates_quarterly","other_costs_monthly",
      "interest_rate","property_growth","rental_growth","year_bought","loan_term_years"
    ];
    numKeys.forEach(k=>{
      if(out[k] === "" || out[k] == null) out[k] = 0;
      out[k] = Number(out[k]);
    });
    out.use_offset = !!out.use_offset;
    return out;
  }

  function renderPropertyCards(){
    const host = document.getElementById("propCards");
    host.innerHTML = "";

    // Investments
    const inv = state.properties.investments || [];
    inv.forEach((p, idx)=>{
      host.appendChild(makePropertyCard(p, `Investment Property ${idx+1}`, false, idx));
    });

    // PPOR
    host.appendChild(makePropertyCard(state.properties.ppor, "PPOR", true, null));

    renderPreviews();
  }

  function makePropertyCard(prop, title, isPPOR, invIndex){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.style.boxShadow = "none";
    wrap.style.marginBottom = "12px";

    const idPrefix = isPPOR ? "ppor" : `inv_${invIndex}`;

    const removeBtn = (!isPPOR)
      ? `<button class="btn danger" onclick="removeInvestmentProperty(${invIndex})">Remove</button>`
      : "";

    wrap.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <h3 style="margin:0;">${title}</h3>
        <div class="actions" style="margin:0;">
          ${removeBtn}
        </div>
      </div>
      <div class="sub" style="margin-top:6px;">
        ${isPPOR ? "Owner-occupied. Rent + rental growth forced to 0." : "Investment property. Rent + costs affect cashflow + tax."}
      </div>

      <div class="row">
        <div>
          <label>name</label>
          <input id="${idPrefix}_name" />
        </div>
        <div>
          <label>id</label>
          <input id="${idPrefix}_id" type="number" step="1" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>year_bought</label>
          <input id="${idPrefix}_year_bought" type="number" step="1" />
        </div>
        <div>
          <label>loan_term_years</label>
          <input id="${idPrefix}_loan_term_years" type="number" step="1" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>purchase_price</label>
          <input id="${idPrefix}_purchase_price" type="number" step="1" />
        </div>
        <div>
          <label>purchase_fees</label>
          <input id="${idPrefix}_purchase_fees" type="number" step="1" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>current_value</label>
          <input id="${idPrefix}_current_value" type="number" step="1" />
        </div>
        <div>
          <label>property_growth</label>
          <input id="${idPrefix}_property_growth" type="number" step="0.001" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>original_loan</label>
          <input id="${idPrefix}_original_loan" type="number" step="1" />
        </div>
        <div>
          <label>loan_balance_current</label>
          <input id="${idPrefix}_loan_balance_current" type="number" step="1" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>interest_rate</label>
          <input id="${idPrefix}_interest_rate" type="number" step="0.001" />
        </div>
        <div>
          <label>use_offset</label>
          <select id="${idPrefix}_use_offset">
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>monthly_rent</label>
          <input id="${idPrefix}_monthly_rent" type="number" step="1" ${isPPOR ? "disabled" : ""} />
        </div>
        <div>
          <label>rental_growth</label>
          <input id="${idPrefix}_rental_growth" type="number" step="0.001" ${isPPOR ? "disabled" : ""} />
        </div>
      </div>

      <div class="row">
        <div>
          <label>strata_quarterly</label>
          <input id="${idPrefix}_strata_quarterly" type="number" step="1" />
        </div>
        <div>
          <label>rates_quarterly</label>
          <input id="${idPrefix}_rates_quarterly" type="number" step="1" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>other_costs_monthly</label>
          <input id="${idPrefix}_other_costs_monthly" type="number" step="1" />
        </div>
        <div>
          <label>is_owner_occupied</label>
          <select id="${idPrefix}_is_owner_occupied" ${isPPOR ? "disabled" : ""}>
            <option value="false">false</option>
            <option value="true">true</option>
          </select>
        </div>
      </div>
    `;

    // fill values
    const p = normalizeProperty(prop, isPPOR, (isPPOR? 999 : invIndex+1));
    const set = (k, v)=>{ const el = wrap.querySelector(`#${idPrefix}_${k}`); if(el) el.value = v; };
    set("name", p.name);
    set("id", p.id);
    set("year_bought", p.year_bought);
    set("loan_term_years", p.loan_term_years);
    set("purchase_price", p.purchase_price);
    set("purchase_fees", p.purchase_fees);
    set("current_value", p.current_value);
    set("property_growth", p.property_growth);
    set("original_loan", p.original_loan);
    set("loan_balance_current", p.loan_balance_current);
    set("interest_rate", p.interest_rate);
    set("use_offset", String(!!p.use_offset));
    set("monthly_rent", p.monthly_rent);
    set("rental_growth", p.rental_growth);
    set("strata_quarterly", p.strata_quarterly);
    set("rates_quarterly", p.rates_quarterly);
    set("other_costs_monthly", p.other_costs_monthly);
    set("is_owner_occupied", String(!!p.is_owner_occupied));

    // onchange -> update state live
    wrap.querySelectorAll("input,select").forEach(el=>{
      el.addEventListener("input", ()=>{ readPropertiesIntoState(); renderPreviews(); });
      el.addEventListener("change", ()=>{ readPropertiesIntoState(); renderPreviews(); });
    });

    return wrap;
  }

  function readPropertiesIntoState(){
    // Investments
    const inv = state.properties.investments || [];
    inv.forEach((p, idx)=>{
      const idPrefix = `inv_${idx}`;
      const get = (k)=>document.getElementById(`${idPrefix}_${k}`)?.value;
      inv[idx] = {
        ...p,
        id: Number(get("id")),
        name: get("name"),
        year_bought: Number(get("year_bought")),
        loan_term_years: Number(get("loan_term_years")),
        purchase_price: Number(get("purchase_price")),
        purchase_fees: Number(get("purchase_fees")),
        current_value: Number(get("current_value")),
        property_growth: Number(get("property_growth")),
        original_loan: Number(get("original_loan")),
        loan_balance_current: Number(get("loan_balance_current")),
        interest_rate: Number(get("interest_rate")),
        use_offset: (get("use_offset") === "true"),
        monthly_rent: Number(get("monthly_rent")),
        rental_growth: Number(get("rental_growth")),
        strata_quarterly: Number(get("strata_quarterly")),
        rates_quarterly: Number(get("rates_quarterly")),
        other_costs_monthly: Number(get("other_costs_monthly")),
        is_owner_occupied: false
      };
    });

    // PPOR
    const getP = (k)=>document.getElementById(`ppor_${k}`)?.value;
    state.properties.ppor = {
      ...state.properties.ppor,
      id: Number(getP("id")),
      name: getP("name"),
      year_bought: Number(getP("year_bought")),
      loan_term_years: Number(getP("loan_term_years")),
      purchase_price: Number(getP("purchase_price")),
      purchase_fees: Number(getP("purchase_fees")),
      current_value: Number(getP("current_value")),
      property_growth: Number(getP("property_growth")),
      original_loan: Number(getP("original_loan")),
      loan_balance_current: Number(getP("loan_balance_current")),
      interest_rate: Number(getP("interest_rate")),
      use_offset: (getP("use_offset") === "true"),
      // forced
      monthly_rent: 0,
      rental_growth: 0,
      strata_quarterly: Number(getP("strata_quarterly")),
      rates_quarterly: Number(getP("rates_quarterly")),
      other_costs_monthly: Number(getP("other_costs_monthly")),
      is_owner_occupied: true
    };
  }

  function addInvestmentProperty(){
    const n = (state.properties.investments || []).length + 1;
    state.properties.investments = state.properties.investments || [];
    state.properties.investments.push({
      id: 100 + n,
      name: `Investment ${n}`,
      purchase_price: 800000,
      current_value: 800000,
      original_loan: 640000,
      loan_balance_current: 0,
      purchase_fees: 30000,
      monthly_rent: 3200,
      strata_quarterly: 0,
      rates_quarterly: 900,
      other_costs_monthly: 200,
      interest_rate: 0.055,
      property_growth: 0.03,
      rental_growth: 0.03,
      year_bought: new Date().getFullYear() + 1,
      loan_term_years: 30,
      use_offset: true,
      is_owner_occupied: false
    });
    renderPropertyCards();
    saveState();
  }

  function removeInvestmentProperty(idx){
    state.properties.investments.splice(idx,1);
    renderPropertyCards();
    saveState();
  }

  function resetProperties(){
    state.properties = structuredClone(defaultState.properties);
    renderPropertyCards();
    saveState();
  }

  // -----------------------------
  // CORE INPUTS
  // -----------------------------
  function syncUIFromState(){
    document.getElementById("apiBase").value = state.apiBase;
    document.getElementById("mode").value = state
