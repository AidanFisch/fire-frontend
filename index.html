<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FIRE Model</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B0F1B;
      --card: rgba(255,255,255,.04);
      --stroke: rgba(255,255,255,.10);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --good:#2ee59d;
      --bad:#ff5c7a;
      --accent:#8b5cf6;
      --accent2:#22d3ee;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --r:18px;
      --r2:26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--txt);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(139,92,246,.22), transparent 55%),
        radial-gradient(900px 550px at 90% 30%, rgba(34,211,238,.18), transparent 60%),
        radial-gradient(900px 700px at 60% 95%, rgba(46,229,157,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .wrap{ max-width:1180px; margin:0 auto; padding:22px 18px 42px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:16px 18px; border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:999px; box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position: sticky; top:12px; z-index:40;
    }
    .brand{ display:flex; align-items:center; gap:12px; font-weight:800; }
    .dot{ width:12px;height:12px;border-radius:99px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 6px rgba(139,92,246,.18);
    }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--stroke); color: var(--muted);
      background: rgba(0,0,0,.2); margin-left: 8px;
    }
    .nav{
      display:flex; gap:8px; align-items:center;
      border:1px solid var(--stroke); background: rgba(0,0,0,.18);
      padding:6px; border-radius:999px;
    }
    .nav button{
      border:1px solid transparent; background:transparent; color: var(--muted);
      padding:8px 14px; border-radius:999px; cursor:pointer; font-size:14px;
    }
    .nav button.active{
      color: var(--txt);
      border-color: rgba(139,92,246,.50);
      background: linear-gradient(135deg, rgba(139,92,246,.22), rgba(34,211,238,.10));
    }
    .tabs{display:none}
    .tabs.active{display:block}

    .grid{ display:grid; gap:16px; }
    .grid.cols2{ grid-template-columns:1fr 1fr; }
    .grid.cols4{ grid-template-columns:1fr 1fr 1fr 1fr; }
    @media (max-width:980px){ .grid.cols2,.grid.cols4{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      padding:18px;
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .sub{ color:var(--muted); font-size:13px; line-height:1.35; }
    .hr{ height:1px; background: var(--stroke); margin:14px 0; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }

    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      color: var(--txt);
      outline:none;
    }
    textarea{ min-height:220px; font-family: var(--mono); font-size:12px; line-height:1.35; }
    .fieldgrid{ display:grid; gap:12px; grid-template-columns:1fr 1fr; }
    @media (max-width:980px){ .fieldgrid{grid-template-columns:1fr} }

    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:650;
    }
    .btn.primary{
      border-color: transparent;
      background: linear-gradient(135deg, rgba(139,92,246,.95), rgba(34,211,238,.75));
      box-shadow: 0 12px 30px rgba(139,92,246,.18);
    }
    .btn.ghost{ background: transparent; }
    .btn.danger{
      border-color: rgba(255,92,122,.35);
      background: rgba(255,92,122,.08);
    }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.16);
      color: var(--muted);
      font-size: 13px;
    }
    .badge .ok{ width:10px;height:10px;border-radius:99px;background: var(--good); }
    .badge .no{ width:10px;height:10px;border-radius:99px;background: var(--bad); }

    .kpi{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      border-radius: var(--r);
      padding:14px 16px;
      min-width:0;
    }
    .kpi .k{ color: var(--muted); font-size:12px; margin-bottom:6px; }
    .kpi .v{ font-size:22px; font-weight:800; }

    .tablewrap{
      width:100%;
      max-width:100%;
      overflow-x:auto;
      overflow-y:hidden;
      border:1px solid var(--stroke);
      border-radius: var(--r);
      background: rgba(0,0,0,.18);
      -webkit-overflow-scrolling: touch;
    }
    table{ width:100%; border-collapse: collapse; min-width: 820px; font-size: 13px; }
    th, td{ padding:10px 10px; border-bottom: 1px solid rgba(255,255,255,.08); white-space: nowrap; }
    th{
      position: sticky; top:0;
      background: rgba(10,13,24,.85);
      backdrop-filter: blur(8px);
      color: rgba(255,255,255,.78);
      font-size:12px;
      text-transform: uppercase;
      letter-spacing: .08em;
      z-index:2;
    }
    .right{text-align:right}
    .mono{font-family: var(--mono)}
    .muted{color: var(--muted)}

    .collapsible{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      border-radius: var(--r2);
      overflow:hidden;
    }
    .collapsibleHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px;
      cursor:pointer; user-select:none;
    }
    .caret{
      width:34px;height:34px;border-radius:999px;border:1px solid var(--stroke);
      display:flex;align-items:center;justify-content:center;
      background: rgba(255,255,255,.04);
      transition: transform .18s ease;
      flex:0 0 auto;
    }
    .collapsible.open .caret{ transform: rotate(180deg); }
    .collapsibleBody{ display:none; padding:12px 14px 14px; border-top:1px solid rgba(255,255,255,.08); }
    .collapsible.open .collapsibleBody{ display:block; }

    .legendPanel{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      border-radius: var(--r);
      padding:10px 12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .legendItem{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
      font-size:12px;
      color: var(--muted);
    }
    .legendItem.active{
      color: var(--txt);
      border-color: rgba(34,211,238,.45);
      background: rgba(34,211,238,.10);
    }
    .swatch{
      width:10px;height:10px;border-radius:99px;
      background: rgba(255,255,255,.65);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .legendActions{
      margin-left:auto;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    @media (max-width:680px){ .legendActions{ width:100%; margin-left:0; } }

    /* ✅ visible error panel */
    .errorPanel{
      border:1px solid rgba(255,92,122,.35);
      background: rgba(255,92,122,.08);
      border-radius: var(--r2);
      padding: 12px 14px;
      display:none;
      margin-top: 12px;
    }
    .errorPanel .t{ font-weight: 800; margin-bottom: 6px; }
    .errorPanel pre{
      margin:0;
      white-space:pre-wrap;
      max-height: 260px;
      overflow:auto;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.86);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <span>FIRE Model</span>
        <span class="pill" id="apiPill">API: …</span>
      </div>
      <div class="nav">
        <button id="btnHome" class="active" onclick="showTab('home')">Home</button>
        <button id="btnInputs" onclick="showTab('inputs')">Inputs</button>
        <button id="btnResults" onclick="showTab('results')">Results</button>
      </div>
    </div>

    <!-- HOME -->
    <section id="tab-home" class="tabs active" style="margin-top:18px;">
      <div class="grid cols2">
        <div class="card">
          <h2 style="margin:0 0 8px 0;">What this does</h2>
          <div class="sub">
            Calls your FastAPI model and renders: KPIs, FIRE-style toggleable chart, and collapsible tables.
          </div>
          <div class="hr"></div>
          <div class="row">
            <button class="btn primary" onclick="showTab('inputs')">Go to inputs</button>
            <div class="row" style="gap:8px;">
              <button class="btn" onclick="pingAPI()">Re-check API</button>
              <button class="btn" onclick="discoverEndpoints()">Discover endpoints</button>
            </div>
          </div>
          <div class="sub" style="margin-top:10px;">
            If your run fails, this page will now show the exact browser error + discovered POST endpoints from OpenAPI.
          </div>
        </div>

        <div class="card">
          <h2 style="margin:0 0 8px 0;">Status</h2>
          <div class="sub">Backend health + endpoint discovery.</div>
          <div class="hr"></div>

          <div class="row" style="margin-bottom:10px;">
            <div class="badge" id="apiBadge"><span class="no"></span><span>API not checked yet</span></div>
            <div class="badge" id="openapiBadge" style="display:none;"><span class="ok"></span><span>OpenAPI loaded</span></div>
          </div>

          <div class="fieldgrid">
            <div>
              <label>API Base URL</label>
              <input id="apiBase" placeholder="https://fire-api-wixz.onrender.com" />
              <div class="sub" style="margin-top:6px;">Must include <span class="mono">https://</span></div>
            </div>
            <div>
              <label>Run endpoint path</label>
              <select id="apiPathSelect" onchange="setApiPath(this.value)">
                <option value="">Auto (try common)</option>
              </select>
              <div class="sub" style="margin-top:6px;">Uses OpenAPI if available; otherwise auto-tries common paths.</div>
            </div>
          </div>

          <div class="hr"></div>
          <div class="sub mono" id="lastRunMeta">No run yet.</div>
        </div>
      </div>
    </section>

    <!-- INPUTS -->
    <section id="tab-inputs" class="tabs" style="margin-top:18px;">
      <div class="grid cols2">
        <div class="card">
          <div class="row">
            <div>
              <h2 style="margin:0 0 6px 0;">Core inputs</h2>
              <div class="sub">Base model settings.</div>
            </div>
            <select id="modeSelect" onchange="setMode(this.value)">
              <option value="yearly">Yearly (recommended)</option>
              <option value="monthly">Monthly (debug)</option>
            </select>
          </div>

          <div class="hr"></div>

          <div class="fieldgrid">
            <div><label>current_age</label><input id="current_age" type="number" step="1"/></div>
            <div><label>end_age</label><input id="end_age" type="number" step="1"/></div>

            <div><label>initial_savings</label><input id="initial_savings" type="number" step="1"/></div>
            <div><label>todays_lifestyle_income</label><input id="todays_lifestyle_income" type="number" step="1"/></div>

            <div><label>current_income</label><input id="current_income" type="number" step="1"/></div>
            <div><label>current_expenses</label><input id="current_expenses" type="number" step="1"/></div>
          </div>

          <div class="hr"></div>
          <div class="row">
            <button class="btn" onclick="toggleAdvanced()">Advanced <span class="pill" id="advPill">Hidden</span></button>
            <div class="row" style="gap:8px;">
              <button class="btn" onclick="resetDefaults()">Reset</button>
              <button class="btn primary" onclick="runModel()">Run model</button>
            </div>
          </div>

          <div id="advancedBox" style="display:none; margin-top:14px;">
            <div class="hr"></div>
            <div class="fieldgrid">
              <div><label>inflation</label><input id="inflation" type="number" step="0.001"/></div>
              <div><label>average_salary_increase</label><input id="average_salary_increase" type="number" step="0.001"/></div>
              <div><label>stock_growth</label><input id="stock_growth" type="number" step="0.001"/></div>
              <div><label>stock_yearly_contribution</label><input id="stock_yearly_contribution" type="number" step="1"/></div>
              <div><label>starting_stock_value</label><input id="starting_stock_value" type="number" step="1"/></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row">
            <div>
              <h2 style="margin:0 0 6px 0;">Properties</h2>
              <div class="sub">Cards → payload automatically.</div>
            </div>
            <div class="row" style="gap:8px;">
              <button class="btn" onclick="addProperty('investment')">+ Investment</button>
              <button class="btn" onclick="addProperty('ppor')">+ PPOR</button>
            </div>
          </div>

          <div class="hr"></div>

          <div id="propsContainer"></div>

          <div class="hr"></div>

          <button class="btn ghost" onclick="toggleRawJson()">Raw JSON (debug)</button>

          <div id="rawJsonBox" style="display:none; margin-top:12px;">
            <label class="muted">property_list (JSON)</label>
            <textarea id="property_json" spellcheck="false"></textarea>
            <div class="row" style="margin-top:10px;">
              <button class="btn" onclick="applyRawJson()">Apply JSON → cards</button>
              <button class="btn danger" onclick="repairJson()">Repair JSON</button>
              <button class="btn" onclick="copyPayload()">Copy payload</button>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- RESULTS -->
    <section id="tab-results" class="tabs" style="margin-top:18px;">
      <div class="card">
        <div class="row">
          <div>
            <h2 style="margin:0 0 6px 0;">Results</h2>
            <div class="sub" id="resultsMeta">Run the model to see output.</div>
          </div>
          <div class="row" style="gap:10px;">
            <button class="btn" onclick="downloadLastCSV()">Download CSV</button>
            <button class="btn" onclick="showTab('inputs')">Edit inputs</button>
          </div>
        </div>

        <!-- ✅ visible error output -->
        <div class="errorPanel" id="errorPanel">
          <div class="t">Run error</div>
          <pre id="errorText"></pre>
          <div class="sub" style="margin-top:8px;">
            If this says “CORS” or “Failed to fetch”, your backend is blocking POST preflight.
            In that case you must enable CORS for POST/OPTIONS on the API.
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid cols4" id="kpiRow">
          <div class="kpi"><div class="k">Cash (end)</div><div class="v" id="kpiCashEnd">—</div></div>
          <div class="kpi"><div class="k">Stocks (end)</div><div class="v" id="kpiStocksEnd">—</div></div>
          <div class="kpi"><div class="k">Property equity (end)</div><div class="v" id="kpiEquityEnd">—</div></div>
          <div class="kpi"><div class="k">Net worth (end)</div><div class="v" id="kpiNWEnd">—</div></div>
        </div>

        <div class="hr"></div>

        <div class="card" style="padding:14px; background: rgba(0,0,0,.18); border-radius: var(--r2); border-color: rgba(255,255,255,.08);">
          <div class="row">
            <div class="badge" id="rowsBadge"><span class="no"></span><span>No rows yet</span></div>
            <div class="badge" id="fireBadge" style="display:none;"><span class="ok"></span><span>FIRE reached</span></div>
          </div>

          <div class="hr" style="margin:12px 0;"></div>

          <div class="legendPanel" id="legendPanel">
            <div class="legendActions">
              <button class="btn" onclick="setChartPreset('key')">Key only</button>
              <button class="btn" onclick="setChartPreset('all')">All</button>
              <button class="btn ghost" onclick="setChartPreset('none')">None</button>
            </div>
          </div>

          <div class="sub" style="margin-top:10px;">
            Left axis = balances (net worth/cash/stocks/equity). Right axis = monthly cashflow (passive income proxy + FIRE target).
          </div>

          <div style="margin-top:12px;">
            <canvas id="chartMain"></canvas>
          </div>
        </div>

        <div class="hr"></div>

        <div class="collapsible open" id="secSummary">
          <div class="collapsibleHeader" onclick="toggleSection('secSummary')">
            <div>
              <div style="font-weight:850;">Summary table</div>
              <div class="sub">Clean, “actually useful” columns (cash/stocks/property/net worth + FIRE).</div>
            </div>
            <div class="caret">▾</div>
          </div>
          <div class="collapsibleBody">
            <div class="tablewrap" id="summaryTableWrap"></div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="collapsible open" id="secPropEnd">
          <div class="collapsibleHeader" onclick="toggleSection('secPropEnd')">
            <div>
              <div style="font-weight:850;">Property breakdown (end row)</div>
              <div class="sub">Per-property values + mortgage + equity at the final timestep.</div>
            </div>
            <div class="caret">▾</div>
          </div>
          <div class="collapsibleBody">
            <div class="tablewrap" id="propEndTableWrap"></div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="collapsible" id="secRaw">
          <div class="collapsibleHeader" onclick="toggleSection('secRaw')">
            <div>
              <div style="font-weight:850;">Raw API response</div>
              <div class="sub">Exact backend return.</div>
            </div>
            <div class="caret">▾</div>
          </div>
          <div class="collapsibleBody">
            <pre id="rawOut" class="mono" style="white-space:pre-wrap; background:rgba(0,0,0,.22); border:1px solid var(--stroke); padding:12px; border-radius: var(--r); max-height:320px; overflow:auto; margin:0;"></pre>
          </div>
        </div>

      </div>
    </section>
  </div>

<script>
const LS_KEY = "fire_frontend_state_v5";

let state = {
  apiBase: "https://fire-api-wixz.onrender.com",
  apiPath: "",
  discoveredPostPaths: [],
  mode: "yearly",
  inputs: {
    current_age: 25,
    end_age: 60,
    inflation: 0.025,
    todays_lifestyle_income: 80000,
    initial_savings: 500000,
    current_income: 310000,
    current_expenses: 64000,
    average_salary_increase: 0.035,
    stock_growth: 0.06,
    stock_yearly_contribution: 20000,
    starting_stock_value: 35000
  },
  property_list: [
    {
      id: 1,
      name: "Apartment",
      purchase_price: 380000,
      current_value: 640000,
      original_loan: 304000,
      loan_balance_current: 215000,
      purchase_fees: 0,
      monthly_rent: 1512,
      strata_quarterly: 0,
      rates_quarterly: 0,
      other_costs_monthly: 0,
      interest_rate: 0.055,
      property_growth: 0.03,
      rental_growth: 0.03,
      year_bought: 2021,
      loan_term_years: 30,
      use_offset: true,
      is_owner_occupied: false
    }
  ],
  lastResult: null,
  chartToggles: {
    netWorth: true,
    cash: true,
    stocks: true,
    propertyEquity: true,
    passiveIncomeProxy: true,
    fireTarget: true,
    netRent: false,
    taxPaid: false,
    stockDraw: false,
    superDraw: false,
    superBalance: false,
    fireGap: false,
    fireEligible: false
  }
};

function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      const p = JSON.parse(raw);
      state = {...state, ...p};
      state.inputs = {...state.inputs, ...(p.inputs||{})};
      state.property_list = p.property_list || state.property_list;
      state.chartToggles = {...state.chartToggles, ...(p.chartToggles||{})};
      state.discoveredPostPaths = p.discoveredPostPaths || [];
    }
  }catch(e){}
}

function showTab(name){
  document.querySelectorAll(".tabs").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".nav button").forEach(el => el.classList.remove("active"));
  document.getElementById(`tab-${name}`).classList.add("active");
  document.getElementById(`btn${name.charAt(0).toUpperCase()+name.slice(1)}`).classList.add("active");
}
function toggleSection(id){ document.getElementById(id)?.classList.toggle("open"); }

function setMode(mode){
  state.mode = mode;
  document.getElementById("modeSelect").value = mode;
  saveState();
}

function toggleAdvanced(){
  const box = document.getElementById("advancedBox");
  const pill = document.getElementById("advPill");
  const show = box.style.display === "none";
  box.style.display = show ? "block" : "none";
  pill.textContent = show ? "Shown" : "Hidden";
}

function setApiPath(path){
  state.apiPath = path || "";
  saveState();
}

function bindCoreInputs(){
  document.getElementById("apiBase").value = state.apiBase || "";
  document.getElementById("apiBase").oninput = (e)=>{
    state.apiBase = e.target.value.trim();
    saveState();
    pingAPI();
    discoverEndpoints();
  };

  for(const k of Object.keys(state.inputs)){
    const el = document.getElementById(k);
    if(!el) continue;
    el.value = state.inputs[k];
    el.oninput = ()=>{ state.inputs[k] = toNumber(el.value); saveState(); };
  }
}

function toggleRawJson(){
  const box = document.getElementById("rawJsonBox");
  box.style.display = (box.style.display==="none") ? "block" : "none";
  syncRawJsonFromCards();
}
function syncRawJsonFromCards(){
  const ta = document.getElementById("property_json");
  if(ta) ta.value = JSON.stringify(state.property_list, null, 2);
}
function applyRawJson(){
  try{
    const parsed = JSON.parse(document.getElementById("property_json").value);
    if(!Array.isArray(parsed)) throw new Error("property_list must be an array");
    state.property_list = parsed.map((p, idx)=>({ ...p, id: Number(p.id ?? (idx+1)) || (idx+1) }));
    saveState();
    renderProperties();
    alert("Applied JSON → cards.");
  }catch(e){
    alert("JSON parse failed: " + e.message);
  }
}
function repairJson(){
  let s = document.getElementById("property_json").value;
  s = s.replace(/[“”]/g,'"').replace(/[‘’]/g,"'");
  s = s.replace(/,\s*([}\]])/g, "$1");
  document.getElementById("property_json").value = s;
  alert("Repaired common issues. Try Apply JSON → cards.");
}
function copyPayload(){
  const payload = buildPayload();
  navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
  alert("Copied payload.");
}

function nextPropertyId(){
  return Math.max(0, ...state.property_list.map(p=>Number(p.id)||0)) + 1;
}
function addProperty(kind){
  const id = nextPropertyId();
  if(kind === "ppor"){
    state.property_list.push({
      id,
      name: "PPOR",
      purchase_price: 1100000,
      current_value: 1100000,
      original_loan: 650000,
      loan_balance_current: 0,
      purchase_fees: 30000,
      monthly_rent: 0,
      strata_quarterly: 0,
      rates_quarterly: 0,
      other_costs_monthly: 0,
      interest_rate: 0.055,
      property_growth: 0.03,
      rental_growth: 0.0,
      year_bought: new Date().getFullYear()+2,
      loan_term_years: 30,
      use_offset: true,
      is_owner_occupied: true
    });
  }else{
    state.property_list.push({
      id,
      name: "House",
      purchase_price: 1600000,
      current_value: 1600000,
      original_loan: 1280000,
      loan_balance_current: 0,
      purchase_fees: 80000,
      monthly_rent: 5333,
      strata_quarterly: 0,
      rates_quarterly: 0,
      other_costs_monthly: 0,
      interest_rate: 0.055,
      property_growth: 0.03,
      rental_growth: 0.03,
      year_bought: new Date().getFullYear()+1,
      loan_term_years: 30,
      use_offset: true,
      is_owner_occupied: false
    });
  }
  saveState();
  renderProperties();
}

function removeProperty(id){
  state.property_list = state.property_list.filter(p => Number(p.id) !== Number(id));
  saveState();
  renderProperties();
}

function renderProperties(){
  const wrap = document.getElementById("propsContainer");
  wrap.innerHTML = "";

  state.property_list.forEach((p)=>{
    const card = document.createElement("div");
    card.className = "card";
    card.style.marginBottom = "14px";
    card.style.background = "rgba(0,0,0,.18)";
    card.style.borderColor = "rgba(255,255,255,.08)";
    card.style.padding = "14px";

    card.innerHTML = `
      <div class="row">
        <div style="font-weight:850;">${escapeHtml(p.name || "Property")}</div>
        <div class="row" style="gap:8px;">
          <span class="badge"><span class="${p.is_owner_occupied ? "ok":"no"}"></span><span>${p.is_owner_occupied ? "PPOR":"Investment"}</span></span>
          <button class="btn danger" onclick="removeProperty(${Number(p.id)})">Remove</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="fieldgrid" id="grid_${p.id}"></div>
      <div class="hr"></div>
      <div class="row" style="gap:10px;">
        <label class="badge" style="cursor:pointer;">
          <input type="checkbox" id="p_${p.id}_use_offset" style="width:auto; margin-right:8px;" />
          use_offset
        </label>
        <label class="badge" style="cursor:pointer;">
          <input type="checkbox" id="p_${p.id}_is_owner_occupied" style="width:auto; margin-right:8px;" />
          is_owner_occupied
        </label>
      </div>
    `;
    wrap.appendChild(card);

    const fields = [
      ["name","text"],["year_bought","number"],
      ["purchase_price","number"],["purchase_fees","number"],
      ["current_value","number"],["original_loan","number"],
      ["loan_balance_current","number"],["interest_rate","number"],
      ["loan_term_years","number"],["property_growth","number"],
      ["monthly_rent","number"],["rental_growth","number"],
      ["strata_quarterly","number"],["rates_quarterly","number"],["other_costs_monthly","number"]
    ];

    const grid = document.getElementById(`grid_${p.id}`);
    fields.forEach(([key,type])=>{
      const d = document.createElement("div");
      d.innerHTML = `
        <label>${key}</label>
        <input id="p_${p.id}_${key}" type="${type}" />
      `;
      grid.appendChild(d);

      const el = d.querySelector("input");
      el.value = (p[key] ?? "");
      el.oninput = ()=>{
        const prop = state.property_list.find(x=>Number(x.id)===Number(p.id));
        prop[key] = (type==="number") ? toNumber(el.value) : el.value;
        saveState();
        syncRawJsonFromCards();
      };
    });

    const offEl = document.getElementById(`p_${p.id}_use_offset`);
    offEl.checked = !!p.use_offset;
    offEl.onchange = ()=>{
      const prop = state.property_list.find(x=>Number(x.id)===Number(p.id));
      prop.use_offset = !!offEl.checked;
      saveState(); syncRawJsonFromCards();
    };

    const occEl = document.getElementById(`p_${p.id}_is_owner_occupied`);
    occEl.checked = !!p.is_owner_occupied;
    occEl.onchange = ()=>{
      const prop = state.property_list.find(x=>Number(x.id)===Number(p.id));
      prop.is_owner_occupied = !!occEl.checked;
      if(prop.is_owner_occupied){ prop.monthly_rent = 0; prop.rental_growth = 0; }
      saveState();
      renderProperties();
    };
  });

  syncRawJsonFromCards();
}

/* ---------- API ---------- */
async function pingAPI(){
  const base = (state.apiBase||"").replace(/\/+$/,"");
  if(!base){ setApiStatus(false,"missing"); return; }
  try{
    const r = await fetch(base + "/health");
    const j = await r.json().catch(()=>null);
    const ok = !!(j && (j.ok===true || j.status==="ok"));
    setApiStatus(ok, ok ? "ok":"health non-ok");
  }catch(e){
    setApiStatus(false, "unreachable");
  }
}
function setApiStatus(ok, text){
  document.getElementById("apiPill").textContent = `API: ${ok ? "ok":"down"}`;
  document.getElementById("apiBadge").innerHTML = ok
    ? `<span class="ok"></span><span>API reachable (${escapeHtml(text)})</span>`
    : `<span class="no"></span><span>API issue (${escapeHtml(text)})</span>`;
}

async function discoverEndpoints(){
  const base = (state.apiBase||"").replace(/\/+$/,"");
  if(!base) return;
  const sel = document.getElementById("apiPathSelect");
  const openapiBadge = document.getElementById("openapiBadge");
  openapiBadge.style.display = "none";

  // keep current options
  const keepValue = state.apiPath || "";

  // reset options
  sel.innerHTML = `<option value="">Auto (try common)</option>`;

  try{
    const r = await fetch(base + "/openapi.json");
    const j = await r.json();

    const paths = j?.paths || {};
    const postPaths = [];
    for(const path of Object.keys(paths)){
      if(paths[path]?.post) postPaths.push(path);
    }

    state.discoveredPostPaths = postPaths;
    saveState();

    // fill select
    for(const p of postPaths){
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      sel.appendChild(opt);
    }

    if(keepValue && postPaths.includes(keepValue)){
      sel.value = keepValue;
    }else{
      sel.value = "";
    }

    openapiBadge.style.display = "inline-flex";
    openapiBadge.innerHTML = `<span class="ok"></span><span>OpenAPI loaded (${postPaths.length} POST paths)</span>`;
  }catch(e){
    // silent; user can still use auto-try list
  }
}

/* ---------- payload / run ---------- */
function buildPayload(){
  return {
    inputs: state.inputs,
    property_list: state.property_list,
    display_month: (state.mode === "monthly")
  };
}

function showError(msg){
  const panel = document.getElementById("errorPanel");
  panel.style.display = "block";
  document.getElementById("errorText").textContent = msg;
}
function clearError(){
  const panel = document.getElementById("errorPanel");
  panel.style.display = "none";
  document.getElementById("errorText").textContent = "";
}

async function postJson(base, path, payload){
  const url = base + path;
  const r = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const j = await r.json().catch(()=>null);
  if(!r.ok){
    const msg = j ? JSON.stringify(j, null, 2) : (await r.text());
    throw new Error(`HTTP ${r.status} @ ${path}\n${msg}`);
  }
  return j;
}

// ✅ fallback that may avoid CORS preflight on some setups
async function postPlain(base, path, payload){
  const url = base + path;
  const r = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=UTF-8" },
    body: JSON.stringify(payload)
  });
  const j = await r.json().catch(()=>null);
  if(!r.ok){
    const msg = j ? JSON.stringify(j, null, 2) : (await r.text());
    throw new Error(`HTTP ${r.status} @ ${path} (plain)\n${msg}`);
  }
  return j;
}

async function runModel(){
  clearError();
  saveState();

  const base = (state.apiBase||"").replace(/\/+$/,"");
  if(!base){ alert("Set API Base URL first."); return; }

  const payload = buildPayload();

  const explicit = (state.apiPath || "").trim();
  const discovered = (state.discoveredPostPaths || []).slice();

  const common = ["/run","/fire","/fire-model","/model","/run_fire_model","/fire_model","/calculate","/api/run"];

  // try: explicit -> discovered -> common
  const candidates = [];
  if(explicit){
    candidates.push(explicit.startsWith("/") ? explicit : ("/"+explicit));
  }
  for(const p of discovered){
    if(!candidates.includes(p)) candidates.push(p);
  }
  for(const p of common){
    if(!candidates.includes(p)) candidates.push(p);
  }

  document.getElementById("rawOut").textContent = "Running…";
  document.getElementById("resultsMeta").textContent = "Running…";

  let lastErr = null;

  for(const p of candidates){
    try{
      // first try normal JSON
      const res = await postJson(base, p, payload);
      state.lastResult = res;
      saveState();
      document.getElementById("lastRunMeta").textContent =
        `Last run: ${new Date().toLocaleString()} | mode=${res.mode} | endpoint=${p}`;
      renderResults(res);
      showTab("results");
      return;
    }catch(e1){
      lastErr = e1;
      // if it's a fetch/CORS style failure, try the plain fallback
      const msg = String(e1?.message || e1);
      if(/failed to fetch|cors|networkerror|typeerror/i.test(msg)){
        try{
          const res2 = await postPlain(base, p, payload);
          state.lastResult = res2;
          saveState();
          document.getElementById("lastRunMeta").textContent =
            `Last run: ${new Date().toLocaleString()} | mode=${res2.mode} | endpoint=${p} (plain fallback)`;
          renderResults(res2);
          showTab("results");
          return;
        }catch(e2){
          lastErr = e2;
        }
      }
    }
  }

  const extra = state.discoveredPostPaths?.length
    ? `\n\nDiscovered POST endpoints: ${state.discoveredPostPaths.join(", ")}`
    : `\n\nTip: Click “Discover endpoints” on Home to pull POST paths from /openapi.json.`;

  const finalMsg = `Run failed.\n\n${String(lastErr?.message || lastErr)}${extra}`;
  document.getElementById("rawOut").textContent = finalMsg;
  document.getElementById("resultsMeta").textContent = "Run failed. See error panel.";
  showError(finalMsg);
  showTab("results");
}

/* ---------- Chart & tables (same as before, shortened only for readability) ---------- */
let chart = null;

const CHART_METRICS = [
  { id:"netWorth", label:"Net worth", axis:"y", keyCandidates:["Net_Worth_Incl_PPOR","Net_Worth_Incl_Super_Incl_PPOR","Net_Worth_Incl_Super_Ex_PPOR","Net_Worth_Ex_PPOR"], defaultOn:true },
  { id:"cash", label:"Cash", axis:"y", keyCandidates:["Cash_Balance_End","Cumulative_Savings"], defaultOn:true },
  { id:"stocks", label:"Stocks", axis:"y", keyCandidates:["Stock_Balance_End","Total_Stock_Balance"], defaultOn:true },
  { id:"propertyEquity", label:"Property equity", axis:"y", keyCandidates:["Total_Property_Equity","Property_Equity_Total","Total_Property_Equity_Ex_PPOR"], defaultOn:true },
  { id:"superBalance", label:"Super balance", axis:"y", keyCandidates:["Super_Balance_End","Super_Balance"], defaultOn:false },

  { id:"passiveIncomeProxy", label:"Passive income proxy (monthly)", axis:"y2", keyCandidates:["FIRE_Income_Monthly","Fire_Replacement_Cashflow_Monthly"], defaultOn:true },
  { id:"fireTarget", label:"FIRE target (monthly)", axis:"y2", keyCandidates:["Fire_Target_Monthly","Target_Monthly_Infl_Adj"], defaultOn:true },
  { id:"fireGap", label:"FIRE gap (monthly)", axis:"y2", keyCandidates:["Fire_Gap_Monthly"], defaultOn:false },

  { id:"netRent", label:"Net rent", axis:"y2", keyCandidates:["Total_Net_Rent"], defaultOn:false },
  { id:"taxPaid", label:"Tax paid", axis:"y2", keyCandidates:["Tax_Paid","Tax_Payable_Paid"], defaultOn:false },
  { id:"stockDraw", label:"Stock drawdown (monthly)", axis:"y2", keyCandidates:["Stock_Drawdown_Monthly"], defaultOn:false },
  { id:"superDraw", label:"Super drawdown (monthly)", axis:"y2", keyCandidates:["Super_Drawdown_Monthly"], defaultOn:false },
  { id:"fireEligible", label:"FIRE eligible flag", axis:"y2", keyCandidates:["FIRE_Eligible"], defaultOn:false }
];

function toggleMetric(id){
  state.chartToggles[id] = !state.chartToggles[id];
  saveState();
  if(state.lastResult) renderChartWithToggles(state.lastResult);
}
function setChartPreset(which){
  if(which==="key"){
    for(const m of CHART_METRICS) state.chartToggles[m.id] = !!m.defaultOn;
  }else if(which==="all"){
    for(const m of CHART_METRICS) state.chartToggles[m.id] = true;
  }else{
    for(const m of CHART_METRICS) state.chartToggles[m.id] = false;
  }
  saveState();
  if(state.lastResult) renderChartWithToggles(state.lastResult);
}

function renderLegendPanel(series, swatches){
  const panel = document.getElementById("legendPanel");
  panel.querySelectorAll(".legendItem").forEach(x => x.remove());
  const actions = panel.querySelector(".legendActions");

  for(const m of series){
    const on = !!state.chartToggles[m.id];
    const item = document.createElement("div");
    item.className = "legendItem" + (on ? " active" : "");
    item.onclick = ()=>toggleMetric(m.id);

    const sw = document.createElement("span");
    sw.className = "swatch";
    sw.style.background = swatches[m.id] || "rgba(255,255,255,.65)";

    const tx = document.createElement("span");
    tx.textContent = m.label;

    item.appendChild(sw);
    item.appendChild(tx);
    panel.insertBefore(item, actions);
  }
}

function renderChartWithToggles(result){
  const rows = result.rows || [];
  const cols = result.columns || [];
  if(!rows.length) return;

  const yearKey = pickKey(cols, ["Year"]);
  const labels = rows.map(r => yearKey ? String(r[yearKey]) : "");

  const resolved = CHART_METRICS.map(m => ({...m, key: pickKey(cols, m.keyCandidates)})).filter(m=>m.key);

  const palette = [
    "rgba(34,211,238,.85)","rgba(139,92,246,.90)","rgba(46,229,157,.85)","rgba(255,207,92,.85)",
    "rgba(255,92,122,.85)","rgba(255,255,255,.70)","rgba(120,200,255,.85)","rgba(200,120,255,.85)",
    "rgba(120,255,200,.85)","rgba(255,180,120,.85)"
  ];

  const datasets = [];
  const swatches = {};
  let pi = 0;

  for(const m of resolved){
    if(!state.chartToggles[m.id]) continue;
    const color = palette[pi++ % palette.length];
    swatches[m.id] = color;
    const data = rows.map(r => toNumber(r[m.key]));
    datasets.push({
      label: m.label,
      data,
      borderWidth: 2,
      tension: .25,
      pointRadius: (result.mode==="monthly" ? 0 : 2),
      yAxisID: m.axis,
      borderColor: color,
      backgroundColor: color,
      fill: false
    });
  }

  if(!datasets.length){
    datasets.push({
      label: "Select a metric",
      data: rows.map(()=>0),
      borderWidth: 1,
      tension: .25,
      pointRadius: 0,
      yAxisID: "y",
      borderColor: "rgba(255,255,255,.35)",
      backgroundColor: "rgba(255,255,255,.35)"
    });
  }

  renderLegendPanel(resolved, swatches);

  const ctx = document.getElementById("chartMain");
  if(chart){ chart.destroy(); chart=null; }

  chart = new Chart(ctx, {
    type:"line",
    data:{ labels, datasets },
    options:{
      responsive:true,
      plugins:{ legend:{display:false} },
      scales:{
        x:{ ticks:{color:"rgba(255,255,255,.55)"}, grid:{color:"rgba(255,255,255,.06)"} },
        y:{ position:"left", ticks:{color:"rgba(255,255,255,.55)", callback:moneyAxis}, grid:{color:"rgba(255,255,255,.06)"} },
        y2:{ position:"right", ticks:{color:"rgba(255,255,255,.55)", callback:moneyAxis}, grid:{ drawOnChartArea:false } }
      }
    }
  });
}

function renderResults(result){
  const rows = result.rows || [];
  const cols = result.columns || [];
  document.getElementById("rawOut").textContent = JSON.stringify(result, null, 2);

  const n = rows.length;
  document.getElementById("rowsBadge").innerHTML = n
    ? `<span class="ok"></span><span>${n} rows returned (${escapeHtml(result.mode||"")}).</span>`
    : `<span class="no"></span><span>No rows returned.</span>`;

  document.getElementById("resultsMeta").textContent = n ? `Showing ${n} rows (${result.mode}).` : "No rows.";

  if(!n) return;

  const last = rows[n-1];

  const cashKey = pickKey(cols, ["Cash_Balance_End","Cumulative_Savings"]);
  const stockKey = pickKey(cols, ["Stock_Balance_End","Total_Stock_Balance"]);
  const equityKey = pickKey(cols, ["Total_Property_Equity","Property_Equity_Total","Total_Property_Equity_Ex_PPOR"]);
  const nwKey = pickKey(cols, ["Net_Worth_Incl_Super_Incl_PPOR","Net_Worth_Incl_PPOR","Net_Worth_Incl_Super_Ex_PPOR","Net_Worth_Ex_PPOR"]);

  document.getElementById("kpiCashEnd").textContent = fmtMoney(toNumber(last[cashKey]));
  document.getElementById("kpiStocksEnd").textContent = fmtMoney(toNumber(last[stockKey]));
  document.getElementById("kpiEquityEnd").textContent = fmtMoney(toNumber(last[equityKey]));
  document.getElementById("kpiNWEnd").textContent = fmtMoney(toNumber(last[nwKey]));

  const fireBadge = document.getElementById("fireBadge");
  const fireEligKey = pickKey(cols, ["FIRE_Eligible"]);
  if(fireEligKey && toNumber(last[fireEligKey]) === 1){
    fireBadge.style.display = "inline-flex";
  } else {
    fireBadge.style.display = "none";
  }

  renderChartWithToggles(result);

  // Summary + property tables are left minimal h
